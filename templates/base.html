<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}MediFriend - Healthcare Management{% endblock %}</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  
  {% block extra_css %}{% endblock %}
</head>
<body>
  
  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="flash-message flash-{{ category }}">
            <span>{{ message }}</span>
            <button class="flash-close" onclick="this.parentElement.remove()">&times;</button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  
  <!-- Navigation Bar (if logged in) -->
  {% if session.user_id %}
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <i class="fas fa-hospital"></i>
        <span>MediFriend</span>
      </div>
      
      <div class="nav-menu">
        {% if session.role == 'PATIENT' %}
          <a href="{{ url_for('patient.dashboard') }}" class="nav-link" title="Dashboard">
            <i class="fas fa-home"></i>
            <span class="nav-text">Dashboard</span>
          </a>
        {% elif session.role == 'DOCTOR' %}
          <a href="{{ url_for('doctor.dashboard') }}" class="nav-link" title="Dashboard">
            <i class="fas fa-home"></i>
            <span class="nav-text">Dashboard</span>
          </a>
        {% endif %}
        
        {% if session.role == 'PATIENT' or session.role == 'DOCTOR' %}
        <div class="notification-container">
          <a href="#" class="nav-link" id="notificationsBtn" title="Notifications">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationCount" style="display: none;"></span>
            <span class="nav-text">Notifications</span>
          </a>
          <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">
              <h4>Notifications</h4>
            </div>
            <div class="notification-list" id="notificationList">
              <div class="notification-loading">
                <i class="fas fa-spinner fa-spin"></i> Loading...
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        <a href="{{ url_for('auth.profile') }}" class="nav-link" title="Profile">
          <i class="fas fa-user-circle"></i>
          <span class="nav-text">Profile</span>
        </a>
        
        <a href="{{ url_for('auth.logout') }}" class="nav-link logout-link" title="Logout">
          <i class="fas fa-sign-out-alt"></i>
          <span class="nav-text">Logout</span>
        </a>
      </div>
      
      <div class="nav-user-mobile">
        <span class="user-name">{{ session.full_name }}</span>
        <button class="nav-toggle" id="navToggle">
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </div>
  </nav>
  {% endif %}
  
  <!-- Main Content -->
  <main class="main-content">
    {% block content %}{% endblock %}
  </main>
  
  <!-- Footer -->
  <footer class="footer">
    <p>
      Â© 2025 MediFriend | Your Complete Healthcare Companion
      <i class="fa-solid fa-heart heart-icon"></i>
    </p>
  </footer>
  
  {% block extra_js %}{% endblock %}
  
  <script>
    // Auto-hide flash messages after 5 seconds
    setTimeout(() => {
      document.querySelectorAll('.flash-message').forEach(msg => {
        msg.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => msg.remove(), 300);
      });
    }, 5000);
    
    // Mobile navigation toggle
    const navToggle = document.getElementById('navToggle');
    const navMenu = document.querySelector('.nav-menu');
    
    if (navToggle) {
      navToggle.addEventListener('click', () => {
        navMenu.classList.toggle('active');
        const icon = navToggle.querySelector('i');
        icon.classList.toggle('fa-bars');
        icon.classList.toggle('fa-times');
      });
    }
    
    // Notification functionality for patients and doctors
    {% if session.role == 'PATIENT' or session.role == 'DOCTOR' %}
    const notificationsBtn = document.getElementById('notificationsBtn');
    const notificationDropdown = document.getElementById('notificationDropdown');
    const notificationCount = document.getElementById('notificationCount');
    const notificationList = document.getElementById('notificationList');
    const userRole = '{{ session.role }}';
    const apiPrefix = userRole === 'PATIENT' ? '/patient' : '/doctor';
    
    // Format time ago
    function timeAgo(dateString) {
      const now = new Date();
      const past = new Date(dateString);
      const seconds = Math.floor((now - past) / 1000);
      
      if (seconds < 60) return 'Just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return minutes + 'm ago';
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return hours + 'h ago';
      const days = Math.floor(hours / 24);
      if (days < 7) return days + 'd ago';
      return past.toLocaleDateString();
    }
    
    // Fetch and display notifications
    async function loadNotifications() {
      try {
        const response = await fetch(apiPrefix + '/api/notifications');
        const data = await response.json();
        
        if (data.success && data.notifications.length > 0) {
          notificationList.innerHTML = data.notifications.map(notif => {
            const icon = notif.type === 'APPOINTMENT_ACCEPTED' ? 'fa-check-circle' :
                        notif.type === 'APPOINTMENT_REJECTED' ? 'fa-times-circle' :
                        notif.type === 'APPOINTMENT_REQUESTED' ? 'fa-calendar-plus' :
                        'fa-prescription';
            const clickable = notif.link ? '' : 'non-clickable';
            
            return `
              <div class="notification-item ${clickable}" data-link="${notif.link || ''}" data-id="${notif.id}">
                <div class="notification-icon">
                  <i class="fas ${icon}"></i>
                </div>
                <div class="notification-content">
                  <div class="notification-message">${notif.message}</div>
                  <div class="notification-time">${timeAgo(notif.created_at)}</div>
                </div>
              </div>
            `;
          }).join('');
          
          // Add click handlers
          document.querySelectorAll('.notification-item').forEach(item => {
            const link = item.dataset.link;
            if (link) {
              item.addEventListener('click', () => {
                window.location.href = link;
              });
            }
          });
        } else {
          notificationList.innerHTML = `
            <div class="notification-empty">
              <i class="fas fa-bell-slash"></i>
              <p>No new notifications</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading notifications:', error);
        notificationList.innerHTML = `
          <div class="notification-empty">
            <p>Failed to load notifications</p>
          </div>
        `;
      }
    }
    
    // Update notification count
    async function updateNotificationCount() {
      try {
        const response = await fetch(apiPrefix + '/api/notifications/count');
        const data = await response.json();
        
        if (data.success && data.count > 0) {
          notificationCount.textContent = data.count;
          notificationCount.style.display = 'block';
        } else {
          notificationCount.style.display = 'none';
        }
      } catch (error) {
        console.error('Error updating count:', error);
      }
    }
    
    // Toggle notification dropdown
    if (notificationsBtn) {
      notificationsBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        
        const isActive = notificationDropdown.classList.contains('active');
        
        if (!isActive) {
          // Opening - load notifications
          await loadNotifications();
          notificationDropdown.classList.add('active');
          
          // Mark as read after a short delay
          setTimeout(async () => {
            await fetch(apiPrefix + '/api/notifications/mark-read', { method: 'POST' });
            notificationCount.style.display = 'none';
          }, 500);
        } else {
          // Closing
          notificationDropdown.classList.remove('active');
        }
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!notificationsBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
          notificationDropdown.classList.remove('active');
        }
      });
      
      // Initial count load
      updateNotificationCount();
      
      // Poll for new notifications every 30 seconds
      setInterval(updateNotificationCount, 30000);
    }
    {% endif %}
  </script>
</body>
</html>
